<!DOCTYPE html>
<!--Augmented1-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Navigation | DLSJBC Campus Navigator</title>
  <meta name="description" content="Prototype interface for setting up augmented reality navigation across the DLSJBC campus.">
  <link rel="icon" type="image/png" href="assets/logo.jpg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #004aad;
      --primary-strong: #003b8b;
      --secondary: #f5f7fb;
      --surface: #ffffff;
      --text: #1f2933;
      --muted: #65748b;
      --success: #0f9d58;
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Poppins", Arial, sans-serif;
      color: var(--text);
      background: #f8fafc;
    }
    a { color: inherit; text-decoration: none; }
    header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
    }
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }
    .nav-links {
      display: flex;
      gap: 20px;
      color: var(--muted);
      font-weight: 500;
    }
    .nav-links a:hover { color: var(--primary); }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      border: none;
      border-radius: 999px;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      text-decoration: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #0073ff);
      color: #ffffff;
      box-shadow: 0 14px 30px rgba(0, 74, 173, 0.18);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 36px rgba(0, 74, 173, 0.22);
    }
    .brand {
      font-weight: 700;
      color: var(--primary);
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      display: inline-block;
    }
    nav {
      display: flex;
      gap: 20px;
      color: var(--muted);
      font-weight: 500;
    }
    nav a:hover { color: var(--primary); }
    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 26px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary), #0073ff);
      color: #ffffff;
      font-weight: 600;
      box-shadow: 0 14px 30px rgba(0, 74, 173, 0.18);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 36px rgba(0, 74, 173, 0.22);
    }
    .btn-outline {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 10px 20px;
      border-radius: 999px;
      border: 1px solid rgba(0, 74, 173, 0.25);
      background: transparent;
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, border 0.2s ease;
    }
    .btn-outline:hover {
      background: rgba(0, 74, 173, 0.08);
      border-color: rgba(0, 74, 173, 0.45);
    }
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 48px 24px 80px;
    }
    h1 {
      font-size: clamp(2rem, 3.2vw, 3rem);
      margin-bottom: 18px;
    }
    p.lead {
      color: var(--muted);
      max-width: 720px;
      margin-bottom: 42px;
    }
    .grid {
      display: grid;
      gap: 24px;
    }
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
      padding: 24px 28px 32px;
    }
    .card h2 {
      font-size: 1.4rem;
      margin-bottom: 22px;
    }
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #0f172a;
    }
    select {
      width: 100%;
      padding: 16px 20px;
      border-radius: var(--radius);
      border: 1px solid rgba(15, 23, 42, 0.14);
      font-family: "Poppins", Arial, sans-serif;
      font-size: 1rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }
    select:focus {
      outline: none;
      border-color: rgba(0, 74, 173, 0.6);
      box-shadow: 0 0 0 4px rgba(0, 116, 255, 0.12);
    }
    .permission-grid {
      display: grid;
      gap: 18px;
      margin-top: 28px;
    }
    .permission {
      border-radius: var(--radius);
      border: 1px solid rgba(15, 23, 42, 0.08);
      padding: 20px 24px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      background: #f8fafc;
    }
    .permission[data-enabled="true"] {
      border-color: rgba(15, 157, 88, 0.45);
      background: rgba(15, 157, 88, 0.12);
    }
    .permission h3 {
      margin: 0;
      font-size: 1.05rem;
    }
    .permission p {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 0.95rem;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 600;
      background: rgba(0, 74, 173, 0.12);
      color: var(--primary);
    }
    .permission[data-enabled="true"] .status-pill {
      background: rgba(15, 157, 88, 0.18);
      color: var(--success);
    }
    .start-nav {
      margin-top: 32px;
      width: 100%;
      padding: 16px;
      font-size: 1.05rem;
    }
    .info-card {
      border: 1px solid rgba(0, 116, 255, 0.2);
      background: rgba(0, 74, 173, 0.06);
      color: #0f172a;
    }
    .info-card strong { color: var(--primary); }
    .ar-preview {
      position: relative;
      min-height: 460px;
      height: clamp(360px, 60vw, 620px);
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(0, 74, 173, 0.08), rgba(0, 74, 173, 0.02));
      border: 1px dashed rgba(0, 74, 173, 0.3);
      display: grid;
      place-items: center;
      text-align: center;
      padding: 36px;
      color: var(--muted);
      overflow: hidden;
    }

      .ar-preview video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: calc(var(--radius) - 6px);
        display: none;
      }

  .ar-preview video.active { display: block; }

      .ar-preview .placeholder {
        display: grid;
        gap: 12px;
        padding: 20px;
      }

      .ar-preview .placeholder strong {
        display: block;
        color: var(--primary);
        font-size: 1.1rem;
        margin-bottom: 8px;
      }

      .ar-preview .placeholder p {
        display: block;
        font-size: 0.95rem;
        color: var(--muted);
      }

      .mindar-scanner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: min(80%, 400px);
        height: min(60%, 300px);
        border: 3px solid transparent;
        pointer-events: none;
        display: none;
        z-index: 10;
      }

      .mindar-scanner.active {
        display: block;
      }

      .mindar-scanner::before,
      .mindar-scanner::after {
        content: '';
        position: absolute;
        width: 40px;
        height: 40px;
        border: 4px solid var(--primary);
        box-shadow: 0 0 20px rgba(0, 74, 173, 0.5);
      }

      .mindar-scanner::before {
        top: -4px;
        left: -4px;
        border-right: none;
        border-bottom: none;
        border-top-left-radius: 12px;
      }

      .mindar-scanner::after {
        top: -4px;
        right: -4px;
        border-left: none;
        border-bottom: none;
        border-top-right-radius: 12px;
      }

      .mindar-scanner .corner-bl,
      .mindar-scanner .corner-br {
        position: absolute;
        width: 40px;
        height: 40px;
        border: 4px solid var(--primary);
        box-shadow: 0 0 20px rgba(0, 74, 173, 0.5);
      }

      .mindar-scanner .corner-bl {
        bottom: -4px;
        left: -4px;
        border-right: none;
        border-top: none;
        border-bottom-left-radius: 12px;
      }

      .mindar-scanner .corner-br {
        bottom: -4px;
        right: -4px;
        border-left: none;
        border-top: none;
        border-bottom-right-radius: 12px;
      }

      .mindar-scanner .scan-line {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, transparent, var(--primary), transparent);
        box-shadow: 0 0 10px var(--primary);
        animation: scan 2s ease-in-out infinite;
      }

      @keyframes scan {
        0%, 100% {
          transform: translateY(0);
          opacity: 0.8;
        }
        50% {
          transform: translateY(calc(min(60vh, 300px) - 3px));
          opacity: 0.4;
        }
      }

      .mindar-scanner .scan-text {
        position: absolute;
        bottom: -40px;
        left: 50%;
        transform: translateX(-50%);
        color: var(--primary);
        font-size: 0.9rem;
        font-weight: 600;
        white-space: nowrap;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        background: rgba(255, 255, 255, 0.9);
        padding: 6px 16px;
        border-radius: 20px;
      }
      .instruction-list {
        display: grid;
        gap: 14px;
        margin-top: 8px;
        color: var(--muted);
        counter-reset: steps;
      }
      .instruction-list li {
        list-style: none;
        border-radius: 12px;
        background: #ffffff;
        border: 1px solid rgba(15, 23, 42, 0.06);
        padding: 16px 20px;
        position: relative;
        padding-left: 58px;
      }
      .instruction-list li::before {
        counter-increment: steps;
        content: counter(steps);
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), #0073ff);
        color: #ffffff;
        display: grid;
        place-items: center;
        font-weight: 600;
        font-size: 0.9rem;
      }
      #nav-status {
        margin-top: 18px;
        font-weight: 600;
        color: var(--muted);
      }
      #nav-status.success { color: var(--success); }
      #destination-info { margin-top: 24px; line-height: 1.6; color: var(--muted); }
      #destination-info strong { color: #0f172a; }
      .reading {
        margin-top: 10px;
        font-size: 0.85rem;
        color: var(--muted);
      }
      footer {
        padding: 28px 24px;
        text-align: center;
        color: var(--muted);
      }
      @media (min-width: 768px) {
        .permission-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      @media (max-width: 767px) {
        .nav-links { display: none; }
        .nav-container { padding: 16px; }
        .card { padding: 22px 20px 28px; }
        .permission { padding: 18px 18px; }
        .instruction-list li { padding-left: 54px; }

        /* Responsive Improvements for Mobile */
        .ar-preview {
          min-height: 300px;
          height: 50vh;
          padding: 16px;
          border-radius: 12px;
        }

      .ar-preview .placeholder {
        gap: 8px;
        padding: 12px;
      }

          .ar-preview .placeholder strong {
            font-size: 1rem;
          }

        .ar-preview .placeholder p {
          font-size: 0.85rem;
          display: block;
        }
      }

      /* Optional tweak for tablets (medium screens) */
      @media (min-width: 768px) and (max-width: 1023px) {
        .ar-preview {
          min-height: 400px;
          height: 55vh;
          padding: 24px;
        }

        .ar-preview .placeholder strong {
          font-size: 1.05rem;
        }

        .ar-preview .placeholder p {
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div id="site-nav-placeholder"></div>
    </header>
    <script>
      (async () => {
        try {
          const res = await fetch('navigation.html');
          if (res.ok) {
            const html = await res.text();
            const placeholder = document.getElementById('site-nav-placeholder');
            placeholder.innerHTML = html;

                // Mark active nav link after injecting fragment
                const setNavActive = () => {
                  const nav = placeholder.querySelector('.nav-links');
                  if (!nav) return;
                  const links = Array.from(nav.querySelectorAll('a[data-page]'));
                  const path = window.location.pathname.split('/').pop() || 'index.html';
                  const currentPage = path === '' ? 'index' : path.replace('.html', '');

                const pageHasHashLinks = links.some(l => l.getAttribute('data-page') === currentPage && l.getAttribute('data-hash'));

            links.forEach(a => {
              const page = a.getAttribute('data-page');
              const hash = a.getAttribute('data-hash');
              let active = false;

                        if (page === currentPage) {
                          if (hash) {
                            active = (window.location.hash === hash);
                          } else {
                            if (!pageHasHashLinks) {
                              active = (window.location.hash === '' || window.location.hash === '#');
                            } else {
                              active = false;
                            }
                          }
                        }

              if (active) a.setAttribute('data-active', 'true'); else a.removeAttribute('data-active');
            });
          };

                      setNavActive();
                      window.addEventListener('hashchange', setNavActive);
                      window.addEventListener('popstate', setNavActive);

          // Attach nav toggle behavior for mobile
          const attachNavToggle = () => {
            const toggle = placeholder.querySelector('#nav-toggle');
            const nav = placeholder.querySelector('.nav-links');
            if (!toggle || !nav) return;
            toggle.addEventListener('click', () => {
              const isOpen = nav.getAttribute('data-open') === 'true';
              nav.setAttribute('data-open', isOpen ? 'false' : 'true');
              toggle.setAttribute('aria-expanded', String(!isOpen));
            });
            nav.querySelectorAll('a').forEach(a => {
              a.addEventListener('click', () => {
                nav.setAttribute('data-open', 'false');
                toggle.setAttribute('aria-expanded', 'false');
              });
            });
          };

          attachNavToggle();
        } else {
          console.warn('Failed to load navigation fragment:', res.status);
        }
      } catch (e) {
        console.warn('Navigation load error', e);
      }
    })();
  </script>

              <main>
                <h1>AR Navigation</h1>
                <p class="lead">Prototype walkthrough for the augmented reality navigation flow. Select a campus location, confirm permissions, and preview the AR guidance overlay.</p>

    <section class="grid">
      <div class="card">
        <h2>Setup Navigation</h2>
        <label for="destination-select">Select Destination</label>
        <select id="destination-select" aria-label="Select destination" required>
          <option value="" selected disabled>Choose where you want to go</option>
        </select>

        <div id="destination-info" role="status" aria-live="polite"></div>

                  <div class="permission-grid" aria-label="Permission status">
                    <div class="permission" id="camera-card" data-enabled="false">
                      <div>
                        <h3>Camera Access</h3>
                        <p>Required for the live AR overlay.</p>
                      </div>
                      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                        <span class="status-pill" id="camera-status">Disabled</span>
                        <button class="btn-outline" id="camera-btn" type="button">Enable Camera</button>
                        <button class="btn-outline" id="camera-switch" type="button" title="Switch camera" style="display:none;">Back</button>
                      </div>
                    </div>
                    <div class="permission" id="location-card" data-enabled="false">
                      <div>
                        <h3>GPS Location</h3>
                        <p>Required to calculate directions.</p>
                        <p class="reading" id="location-reading" aria-live="polite"></p>
                      </div>
                      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                        <span class="status-pill" id="location-status">Disabled</span>
                        <button class="btn-outline" id="location-btn" type="button">Enable GPS</button>
                      </div>
                    </div>
                  </div>

        <button class="btn-primary start-nav" id="start-btn" type="button">Start AR Navigation</button>
        <div id="nav-status" role="alert"></div>
        <div id="ar-debug" aria-live="polite" style="margin-top:12px;font-size:0.9rem;color:#334;line-height:1.4;
                    background:#f1f5f9;border:1px solid rgba(15,23,42,0.04);padding:10px;border-radius:10px;display:none;
                    max-height:160px;overflow:auto"></div>
      </div>

            <div class="card info-card">
              <h2>AR Camera Preview</h2>
              <div class="ar-preview">
                  <video id="camera-view" playsinline autoplay muted></video>
                  <div id="mindar-container" style="width:100%; height:100%; position:relative; display:none;"></div>
                  <div id="mindar-scanner" class="mindar-scanner" aria-hidden="true">
                    <span class="scan-line" aria-hidden="true"></span>
                    <span class="corner-bl" aria-hidden="true"></span>
                    <span class="corner-br" aria-hidden="true"></span>
                    <span class="scan-text">Scanning for campus marker...</span>
                  </div>
                  <div id="camera-placeholder" class="placeholder">
                  <strong>AR Camera View Placeholder</strong>
                  <p>When navigation begins, this space displays the live camera feed with directional overlays guiding you to your destination.</p>
                </div>
              </div>
            </div>
          </section>

          <section class="card" style="margin-top: 28px;">
            <h2>How to Use AR Navigation</h2>
            <ol class="instruction-list">
              <li>Select your destination from the dropdown menu.</li>
              <li>Allow camera access so the app can display directional overlays.</li>
              <li>Enable GPS permissions for turn-by-turn positioning.</li>
              <li>Tap Start to begin navigating and follow the arrows in real space.</li>
            </ol>
          </section>
        </main>

  <footer>
    <small>&copy; 2025 DLSJBC Campus Navigator. All rights reserved.</small>
  </footer>
  <!-- Three.js and MindAR (image tracking) -->
  <!-- Libraries: we try to use local copies under /assets/libs/ then fall back to CDN.
       The loader below verifies that each library registers its expected global and
       will retry with a stable CDN URL if a local file exists but didn't properly
       register the runtime (prevents "MindAR library not loaded" errors). -->
  <script>
    // Synchronous-ish loader: loads a script and resolves when the script's onload fires.
    function loadScript(url) {
      return new Promise((resolve, reject) => {
        // Avoid loading the same URL twice
        if (Array.from(document.scripts).some(s => s.src && s.src.indexOf(url) !== -1)) {
          // slight async delay to allow globals to appear
          return setTimeout(resolve, 60);
        }
        const s = document.createElement('script');
        s.src = url;
        s.async = false;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load ' + url));
        document.head.appendChild(s);
      });
    }

          // Try local first; if present but the expected global doesn't appear within a short
          // timeout, fall back to CDN. This guards against malformed local files.
          async function tryLoadWithVerification(localPath, cdnUrl, verifyFn, timeout = 3000) {
            // Helper to attempt load and verify
            const attempt = async (url) => {
              try {
                await loadScript(url);
              } catch (e) {
                throw e;
              }
              // wait up to `timeout` ms for verifyFn to return true
              const start = Date.now();
              while (Date.now() - start < timeout) {
                try {
                  if (verifyFn()) return true;
                } catch(e) {}
                // small delay
                await new Promise(r => setTimeout(r, 50));
              }
              return false;
            };

        if (!localPath) {
          const ok = await attempt(cdnUrl);
          if (!ok) throw new Error('Loaded ' + cdnUrl + ' but verification failed');
          return;
        }

      // First, try localPath if reachable via HEAD. If HEAD fails or the
      // response looks like HTML (upload page or rewrite), skip to CDN.
      try {
        const head = await fetch(localPath, { method: 'HEAD' });
        if (head.ok) {
          const contentType = head.headers.get('content-type') || '';
          if (contentType.toLowerCase().includes('text/html')) {
            console.warn(localPath, 'HEAD returned HTML (likely a rewrite or upload page); skipping local load');
          } else {
            try {
              const ok = await attempt(localPath);
              if (ok) return;
              console.warn(localPath, 'loaded but verification failed; falling back to CDN');
            } catch (e) {
              console.warn('Error loading local', localPath, e);
            }
          }
        }
      } catch (e) {
        // local HEAD failed, proceed to CDN
      }

            // Try CDN (stable specific version urls are preferred)
            try {
              const ok = await attempt(cdnUrl);
              if (!ok) throw new Error('Loaded ' + cdnUrl + ' but verification failed');
            } catch (e) {
              throw e;
            }
          }

    // Expose helpers for the main script below
    window.__arLoadHelpers = { loadScript, tryLoadWithVerification };
  </script>

  <!-- provide versioned CDN fallbacks here -->
  <script>
    (async function(){
      const helpers = window.__arLoadHelpers;
      if (!helpers) return;
      try {
        // Load MindAR bundle only — it includes Three.js internally.
        await helpers.tryLoadWithVerification(null, 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.5/dist/mindar-image-three.prod.js', () => window.MINDAR && window.MINDAR.IMAGE && window.MINDAR.IMAGE.THREE);
        setARDebug('Loaded MindAR (includes Three.js).');
      } catch (e) {
        console.error('Failed to load MindAR:', e);
      }
    })();
  </script>

        <script>
          const locations = [
            { id: "1", name: "Main Building", description: "Central Administrative Officess", hours: "7:00 AM - 5:00 PM", hasTarget: true },
            { id: "2", name: "Registrar's Office", description: "Student records, enrollment, and registration services", hours: "8:00 AM - 5:00 PM", hasTarget: false },
            { id: "3", name: "Library", description: "Multi-level Academic library with study areas", hours: "7:00 AM - 9:00 PM", hasTarget: false },
            { id: "4", name: "Learning Center", description: "Student dining hall and food services", hours: "6:30 AM - 7:00 PM", hasTarget: false },
            { id: "5", name: "Computer Laboratories", description: "Student center for learning and activities.", hours: "8:00 AM - 6:00 PM", hasTarget: false },
            { id: "6", name: "Student Affairs Office", description: "Student services, organizations, and activities", hours: "8:00 AM - 5:00 PM", hasTarget: false },
            { id: "7", name: "Chapel", description: "Campus chapel for worship and reflection", hours: "6:00 AM - 6:00 PM", hasTarget: false },
            { id: "8", name: "Scubilion Gymnasium", description: "Sports and physical education facility", hours: "6:00 AM - 8:00 PM", hasTarget: false }
          ];

    const selectEl = document.getElementById("destination-select");
    const infoEl = document.getElementById("destination-info");
    const cameraCard = document.getElementById("camera-card");
    const cameraBtn = document.getElementById("camera-btn");
    const cameraStatus = document.getElementById("camera-status");
    const cameraView = document.getElementById("camera-view");
    const cameraPlaceholder = document.getElementById("camera-placeholder");
    const locationCard = document.getElementById("location-card");
    const locationBtn = document.getElementById("location-btn");
    const locationStatus = document.getElementById("location-status");
    const locationReading = document.getElementById("location-reading");
    const startBtn = document.getElementById("start-btn");
    const navStatus = document.getElementById("nav-status");
    const mindarScanner = document.getElementById("mindar-scanner");
    const scannerText = mindarScanner ? mindarScanner.querySelector(".scan-text") : null;
    const detectionTone = new Audio('assets/audio/detection.wav');
    detectionTone.preload = 'auto';

    let cameraStream = null;
    let locationWatchId = null;
  let currentFacing = 'environment'; // 'environment' (back) or 'user' (front)

          function setNavStatus(message = "", isSuccess = false) {
            navStatus.textContent = message;
            if (isSuccess) {
              navStatus.classList.add("success");
            } else {
              navStatus.classList.remove("success");
            }
          }

    // AR debug helper: shows loader / verification messages in the page
    function showARDebug() {
      const el = document.getElementById('ar-debug');
      if (el) el.style.display = 'block';
    }
    function setARDebug(message) {
      try {
        const el = document.getElementById('ar-debug');
        if (!el) return;
        showARDebug();
        const now = new Date().toLocaleTimeString();
        const row = document.createElement('div');
        row.textContent = `[${now}] ${message}`;
        el.appendChild(row);
        // keep scroll at bottom
        el.scrollTop = el.scrollHeight;
      } catch (e) { console.debug('ARDebug error', e); }
    }

    function populateOptions() {
      locations.forEach(loc => {
        const option = document.createElement("option");
        option.value = loc.id;
        option.textContent = loc.hasTarget ? loc.name : `${loc.name} (AR coming soon)`;
        option.dataset.arReady = String(Boolean(loc.hasTarget));
        selectEl.append(option);
      });
    }

    function getLocationById(id) {
      if (!id) return null;
      return locations.find(loc => loc.id === id) || null;
    }

    function ensureDestinationSelected() {
      selectEl.required = true;
      if (selectEl.value) {
        selectEl.setCustomValidity("");
        return true;
      }
      selectEl.setCustomValidity("Please select a destination before continuing.");
      selectEl.reportValidity();
      return false;
    }

          function updateInfo(id) {
            const destination = getLocationById(id);
            if (!destination) {
              infoEl.textContent = "";
              return;
            }
            const parts = [destination.description];
            if (destination.floor) parts.push(`Floor: ${destination.floor}`);
            if (destination.hours) parts.push(`Hours: ${destination.hours}`);
            const arNote = destination.hasTarget
              ? "AR marker ready for this destination."
              : "AR marker coming soon - only Main Building currently supports AR navigation.";
            const htmlParts = [`<strong>Destination:</strong> ${destination.name}`];
            if (parts.length) htmlParts.push(parts.join("<br>"));
            htmlParts.push(`<span style="display:block;margin-top:8px;color:var(--primary);font-weight:600;font-size:0.9rem;">${arNote}</span>`);
            infoEl.innerHTML = htmlParts.join("<br>");
          }

    function setPermissionState(card, pill, enabled) {
      card.dataset.enabled = String(enabled);
      pill.textContent = enabled ? "Enabled" : "Disabled";
    }

    function disableCameraStream(message) {
      // (removed duplicate simple implementation)
    }

          async function startPreview(facing = 'environment') {
            // start a getUserMedia preview in the cameraView element
            currentFacing = facing;
            // stop existing preview first
            if (cameraStream) {
              cameraStream.getTracks().forEach(t => t.stop());
              cameraStream = null;
            }
            try {
              const constraints = { video: { facingMode: facing } };
              setARDebug('Requesting preview stream with facingMode=' + facing);
              const stream = await navigator.mediaDevices.getUserMedia(constraints);
              cameraStream = stream;
              cameraView.srcObject = stream;
              cameraView.classList.add('active');
              cameraPlaceholder.hidden = true;
              setPermissionState(cameraCard, cameraStatus, true);
              cameraBtn.textContent = 'Disable Camera';
              // show switch control
              const switchBtn = document.getElementById('camera-switch');
              if (switchBtn) { switchBtn.style.display = ''; switchBtn.textContent = (facing === 'environment' ? 'Back' : 'Front'); }
              setARDebug('Preview started');
            } catch (e) {
              setARDebug('Preview error: ' + (e && e.message ? e.message : e));
              setNavStatus('Camera preview error: ' + (e && e.message ? e.message : e));
              throw e;
            }
          }

    async function switchCamera() {
      // toggle facing and restart preview or MindAR accordingly
      currentFacing = currentFacing === 'environment' ? 'user' : 'environment';
      setARDebug('Switching camera to ' + currentFacing);
      // if MindAR is running, restart it with new facing
      if (mindarStarted) {
        try {
          await stopMindAR();
          await startMindAR(currentFacing);
        } catch (e) {
          setARDebug('Switch camera (MindAR) error: ' + (e && e.message ? e.message : e));
        }
        return;
      }
      // otherwise restart preview
      try {
        await startPreview(currentFacing);
      } catch (e) {
        console.error('Failed to switch preview camera', e);
      }
    }

    // (removed duplicate simple toggle; consolidated later in file)

          function disableLocationTracking(message) {
            if (locationWatchId !== null && navigator.geolocation && typeof navigator.geolocation.clearWatch === "function") {
              navigator.geolocation.clearWatch(locationWatchId);
              locationWatchId = null;
            }
            setPermissionState(locationCard, locationStatus, false);
            locationReading.textContent = "";
            locationBtn.disabled = false;
            locationBtn.textContent = "Enable GPS";
            if (message) {
              setNavStatus(message);
            }
          }

    function toggleLocation() {
      if (locationCard.dataset.enabled === "true") {
        disableLocationTracking("GPS tracking disabled.");
        return;
      }
      if (!navigator.geolocation) {
        setNavStatus("Geolocation is not supported in this browser.");
        return;
      }
      locationBtn.disabled = true;
      locationBtn.textContent = "Requesting...";
      setNavStatus("");
      try {
        locationWatchId = navigator.geolocation.watchPosition(
          (position) => {
            const { latitude, longitude, accuracy } = position.coords;
            const firstFix = locationCard.dataset.enabled !== "true";
            if (firstFix) {
              setPermissionState(locationCard, locationStatus, true);
              setNavStatus("GPS tracking enabled.");
            }
            locationBtn.disabled = false;
            locationBtn.textContent = "Disable GPS";
            locationReading.textContent = `Lat: ${latitude.toFixed(5)}, Lng: ${longitude.toFixed(5)} (±${Math.round(accuracy)}m)`;
          },
          (error) => {
            disableLocationTracking(`Location error: ${error.message}`);
          },
          { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
        );
      } catch (error) {
        disableLocationTracking(`Location error: ${error.message}`);
      }
    }


      function setScannerState(isActive, message) {
        if (!mindarScanner) return;
        mindarScanner.classList.toggle("active", Boolean(isActive));
        if (scannerText) {
          if (message) {
            scannerText.textContent = message;
          } else if (isActive && scannerText.textContent.trim() === "") {
            scannerText.textContent = "Scanning for campus marker...";
          }
        }
      }
    cameraBtn.addEventListener("click", toggleCamera);
  const cameraSwitchBtn = document.getElementById('camera-switch');
  if (cameraSwitchBtn) cameraSwitchBtn.addEventListener('click', switchCamera);
    locationBtn.addEventListener("click", toggleLocation);

          selectEl.addEventListener("change", () => {
            selectEl.setCustomValidity("");
            updateInfo(selectEl.value);
            setNavStatus("");
          });

    startBtn.addEventListener("click", async () => {
      const cameraReady = cameraCard.dataset.enabled === "true";
      const locationReady = locationCard.dataset.enabled === "true";

      if (!ensureDestinationSelected()) {
        setNavStatus("Select a destination to begin.");
        return;
      }
      const selectedLocation = getLocationById(selectEl.value);
      if (!selectedLocation || !selectedLocation.hasTarget) {
        setNavStatus("Only Main Building currently has an AR marker. Select Main Building to start AR navigation.");
        return;
      }
      if (!cameraReady || !locationReady) {
        setNavStatus("Enable camera and GPS permissions to continue.");
        return;
      }
      // Start MindAR with the selected facing if not already started
      try {
        if (!mindarStarted) {
          setNavStatus('Starting AR session...');
          await startMindAR(currentFacing);
        }
        setNavStatus("AR Navigation started — follow the on-screen arrows!", true);
      } catch (e) {
        setNavStatus('AR start error: ' + (e && e.message ? e.message : e));
      }
    });

          populateOptions();
          const params = new URLSearchParams(window.location.search);
          const initialDestination = params.get("destination");
          if (initialDestination && locations.some(loc => loc.id === initialDestination)) {
            selectEl.value = initialDestination;
            updateInfo(initialDestination);
          }

    window.addEventListener("beforeunload", () => {
      disableCameraStream();
      disableLocationTracking();
    });

    // MindAR integration variables and helpers
    let mindarThree = null;
    let mindarStarted = false;

          async function startMindAR() {
            // Determine which compiled .mind target file is available.
            async function chooseTargetFile() {
              const candidates = [
                'assets/libs/targets.mind',
              ];
              for (const p of candidates) {
                try {
                  const res = await fetch(p, { method: 'HEAD' });
                  if (!res.ok) continue;
                  const ct = (res.headers.get('content-type') || '').toLowerCase();
                  // If server returns HTML, it's likely a rewrite/upload page; skip it
                  if (ct.includes('text/html')) continue;
                  return p;
                } catch (e) {
                  // ignore and continue
                }
              }
              return 'assets/targets/bgschool.mind'; // default (will trigger debug if missing)
            }
            const targetFile = await chooseTargetFile(); // resolved path to use
            setARDebug('Using target file: ' + targetFile);
            const container = document.getElementById("mindar-container");
            setARDebug('startMindAR invoked');
            if (!container) {
              setNavStatus("MindAR container not found in DOM.");
              throw new Error("MindAR container not found");
            }

      // Show container and hide placeholder
      container.style.display = "block";
      cameraPlaceholder.hidden = true;
      setScannerState(true, "Align your device with the campus marker");
      setARDebug('Displayed MindAR container; checking libraries...');

      // Use the global loader helpers (injected earlier) if available. This
      // verifies that a loaded script actually registered the expected global
      // (prevents a malformed local file leaving the page without MINDAR).
      const helpers = window.__arLoadHelpers;
      try {
        // Only load MindAR (it bundles Three.js). Avoid loading a separate THREE to prevent duplicate instances.
        if (!window.MINDAR || !window.MINDAR.IMAGE || !window.MINDAR.IMAGE.THREE) {
          if (helpers && helpers.tryLoadWithVerification) {
            await helpers.tryLoadWithVerification(null, 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.5/dist/mindar-image-three.prod.js', () => window.MINDAR && window.MINDAR.IMAGE && window.MINDAR.IMAGE.THREE);
          } else {
            await (async function simpleLoad(cdnUrl) {
              const loadScript = (url) => new Promise((resolve, reject) => {
                if (Array.from(document.scripts).some(s => s.src && s.src.indexOf(url) !== -1)) return setTimeout(resolve, 50);
                const s = document.createElement('script'); s.src = url; s.async = false; s.onload = () => resolve(); s.onerror = () => reject(new Error('Failed to load ' + url)); document.head.appendChild(s);
              });
              await loadScript(cdnUrl);
            })('https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.5/dist/mindar-image-three.prod.js');
          }
        }
        setARDebug(window.MINDAR && window.MINDAR.IMAGE && window.MINDAR.IMAGE.THREE ? 'MINDAR + internal THREE available' : 'MINDAR or internal THREE still undefined after load');
      } catch (err) {
        container.style.display = "none";
        cameraPlaceholder.hidden = false;
        console.error('AR library load error', err);
        setNavStatus('Failed to load AR libraries. Check network, CDN, or download local libs to /assets/libs/. See console for details.');
        setScannerState(false);
        throw err;
      }

            // Final verification that MindAR registered correctly
            if (!window.MINDAR || !window.MINDAR.IMAGE) {
              setARDebug('Final verification failed: MINDAR not loaded');
              container.style.display = "none";
              cameraPlaceholder.hidden = false;
              setNavStatus('MindAR library not loaded.');
              setScannerState(false);
              throw new Error('MindAR library not loaded');
            }

      // Use MindAR's internal THREE instance to avoid multiple Three.js copies.
      const THREE = window.MINDAR && window.MINDAR.IMAGE && window.MINDAR.IMAGE.THREE;

      // Check whether the compiled target file exists (HEAD request)
      try {
        const headRes = await fetch(targetFile, { method: 'HEAD' });
        const ct = (headRes.headers.get('content-type') || '').toLowerCase();
        setARDebug(`Target file HEAD ${targetFile}: ${headRes.status} ${headRes.statusText} (content-type: ${ct})`);
        if (!headRes.ok || ct.includes('text/html')) {
          setARDebug('Target file not found or served as HTML; tracking will not work until a valid .mind exists.');
          setNavStatus('Target file missing or invalid: put a compiled .mind into assets/targets/ and ensure it is served as binary.');
        }
      } catch (e) {
        setARDebug('Error checking target file: ' + e.message);
      }

      // Remove MindAR's default scanning overlay if it already injected one
      document.querySelectorAll('.mindar-ui-overlay').forEach(el => el.remove());

              mindarThree = new window.MINDAR.IMAGE.MindARThree({
                container: container,
                imageTargetSrc: targetFile,
                maxTrack: 1,
                uiLoading: false,
                uiError: false,
                uiScanning: false,
              });

      const { renderer, scene, camera } = mindarThree;
      const anchor = mindarThree.addAnchor(0);

      // simple visible plane when target is found
      const geometry = new THREE.PlaneGeometry(1, 0.5);
      const material = new THREE.MeshBasicMaterial({ color: 0x004aad, opacity: 0.9, transparent: true });
      const plane = new THREE.Mesh(geometry, material);
      plane.position.set(0, 0, 0);
      plane.visible = false;
      anchor.group.add(plane);

      anchor.onTargetFound = () => {
        plane.visible = true;
        setPermissionState(cameraCard, cameraStatus, true);
        if (typeof setNavStatus === "function") setNavStatus("Main Building detected — matching target image.", true);
        setScannerState(false);
        try {
          detectionTone.currentTime = 0;
          detectionTone.play().catch(() => {});
        } catch (e) {
          setARDebug('Audio play error: ' + (e && e.message ? e.message : e));
        }
      };
      anchor.onTargetLost = () => {
        plane.visible = false;
        setPermissionState(cameraCard, cameraStatus, false);
        if (typeof setNavStatus === "function") setNavStatus("");
        setScannerState(true, "Searching for marker...");
      };

            try {
              await mindarThree.start();
              renderer.setAnimationLoop(() => {
                renderer.render(scene, camera);
              });
              mindarStarted = true;
            } catch (err) {
              // cleanup on failure
              try { await mindarThree.stop(); } catch (e) {}
              container.style.display = "none";
              cameraPlaceholder.hidden = false;
              setScannerState(false);
              mindarThree = null;
              mindarStarted = false;
              throw err;
            }
          }

    async function stopMindAR() {
      if (mindarThree && mindarStarted) {
        try {
          await mindarThree.stop();
        } catch (e) {}
        mindarThree.renderer.setAnimationLoop(null);
        mindarThree = null;
      }
      mindarStarted = false;
      const container = document.getElementById("mindar-container");
      if (container) container.style.display = "none";
      cameraPlaceholder.hidden = false;
      setPermissionState(cameraCard, cameraStatus, false);
      setScannerState(false);
    }

    // Update camera controls to use MindAR instead of direct getUserMedia when enabled
    async function toggleCamera() {
      if (cameraCard.dataset.enabled === "true") {
        // stop MindAR if running
        await stopMindAR();
        disableCameraStream("Camera access disabled.");
        return;
      }

      if (!ensureDestinationSelected()) {
        selectEl.focus();
        return;
      }

      const selectedLocation = getLocationById(selectEl.value);
      if (!selectedLocation) {
        setNavStatus("Select a destination before enabling the camera.");
        selectEl.focus();
        return;
      }
      if (!selectedLocation.hasTarget) {
        setNavStatus(`${selectedLocation.name} does not have an AR marker yet. Select Main Building to use the AR camera.`);
        return;
      }

            cameraBtn.disabled = true;
            cameraBtn.textContent = "Enabling...";
            setNavStatus("");

            try {
              // Start preview first (so user sees camera) with the currentFacing
              await startPreview(currentFacing);
              // Then try to start MindAR (it will reuse camera if supported)
              await startMindAR(currentFacing);
              setPermissionState(cameraCard, cameraStatus, true);
              cameraBtn.textContent = "Disable Camera";
              setNavStatus("Camera and image tracking enabled.");
            } catch (error) {
              // If MindAR fails, show message and restore placeholder
              await stopMindAR();
              setNavStatus(`Camera/MindAR error: ${error.message}`);
            } finally {
              cameraBtn.disabled = false;
            }
          }

      // Ensure disabling camera also stops MindAR
      const _origDisableCameraStream = disableCameraStream;
      function disableCameraStream(message) {
        // stop any existing getUserMedia stream
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
          cameraStream = null;
        }
        // also stop MindAR if active
        if (mindarStarted) {
          stopMindAR();
        }
        cameraView.srcObject = null;
        cameraView.classList.remove("active");
        cameraPlaceholder.hidden = false;
        setPermissionState(cameraCard, cameraStatus, false);
        cameraBtn.disabled = false;
        cameraBtn.textContent = "Enable Camera";
        setScannerState(false);
        if (message) {
          setNavStatus(message);
        }
      }
    </script>
  </body>
  </html>
